<h1>Follower UI</h1>

<video id="selfcam" volume="0" autoplay></video>

<pre id="log">
</pre>

<script>
///// 3rdPARTY: https://gist.github.com/salzhrani/02a6e807f24785a4d34b
if( !HTMLCanvasElement.prototype.toBlob ) {
  Object.defineProperty( HTMLCanvasElement.prototype, 'toBlob',
  { 
    value: function( callback, type, quality )
    {
      var bin = atob( this.toDataURL( type, quality ).split(',')[1] ),
      len = bin.length,
      len32 = len >> 2,
      a8 = new Uint8Array( len ),
      a32 = new Uint32Array( a8.buffer, 0, len32 );

      for( var i=0, j=0; i < len32; i++ )
      {
        a32[i] = bin.charCodeAt(j++) |
          bin.charCodeAt(j++) << 8 |
          bin.charCodeAt(j++) << 16 |
          bin.charCodeAt(j++) << 24;
      }

      var tailLength = len & 3;

      while( tailLength-- )
      {
        a8[ j ] = bin.charCodeAt(j++);
      }

      callback( new Blob( [a8], {'type': type || 'image/jpeg'} ) );
    }
  });
}
///// end 3rdparty


// Listen to window.base_url + /ws/
window.base_url_http = location.protocol+'//'+location.hostname+(location.port ? ':'+location.port: '');
if (location.protocol.indexOf('https') >= 0) {
  window.base_url_ws = 'wss://'+location.hostname+(location.port ? ':'+location.port: '')+'/ws';
}
else {
  window.base_url_ws = 'ws://'+location.hostname+(location.port ? ':'+location.port: '')+'/ws';
}

window.log_e = document.getElementById('log');
window.selfcam_e = document.getElementById('selfcam');

window.ws = new WebSocket(window.base_url_ws);

window.ws.onopen = function (event) {
  var name = localStorage.getItem('name');
  if (!name) {
    name = window.prompt('What is your name?', 'idk man');
    localStorage.setItem('name', name);
  }

  // Tell the server who we are
  window.ws.send(JSON.stringify({
    'event': 'follower-joined',
    'name': name
  }));

};

window.ws.onmessage = function (event) {
  if (typeof event.data === "string") {
    console.log(event.data);
    window.log_e.innerHTML += event.data+'\n';
  }
  else {
    //console.log('event.data must be binary');

  }
};

// Begin asking for video
navigator.mediaDevices.getUserMedia({video: true, audio: true}).
  then((stream) => {
    // Save stream to local view
    window.selfcam_e.srcObject = stream;
    window.selfcam_e.volume = 0;
  });

// We forward the video contents every "frame"
window.selfcam_e.addEventListener('timeupdate', function(e) {
  if (window.selfcam_e.paused !== true) {
    if (!window.hidden_canvas) {
      window.hidden_canvas = document.createElement('canvas');
      window.hidden_canvas.height = window.selfcam_e.videoHeight / 2;
      window.hidden_canvas.width = window.selfcam_e.videoWidth / 2;
    }
    var ctx = window.hidden_canvas.getContext('2d');
    ctx.drawImage(window.selfcam_e, 0, 0, window.hidden_canvas.width, window.hidden_canvas.height);

    window.hidden_canvas.toBlob(function (blob) {
      window.ws.send(blob);
    }, 'image/jpeg');

  }
}, false);

</script>

